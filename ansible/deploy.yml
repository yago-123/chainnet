- name: Deploy application from Git
  hosts: nodes
  become: yes
  become_method: sudo

  vars:
    app_dir: /var/chainnet
    repo_url: 'https://github.com/yago-123/chainnet.git'
    branch: 'master'
    go_version: '1.23.0'
    go_bin_path: "{{ ansible_env.HOME }}/go/bin"
  tasks:
    - name: Update apt package index
      apt:
        update_cache: yes
      tags:
        - update

    - name: Ensure necessary packages are installed
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - make
        - protobuf-compiler
      tags:
        - packages

    - name: Create application directory
      file:
        path: "{{ app_dir }}"
        state: directory
        mode: '0755'
      tags:
        - directory

    - name: Clone the repository
      git:
        repo: "{{ repo_url }}"
        dest: "{{ app_dir }}"
        version: "{{ branch }}"
        force: yes
        update: yes
      tags:
        - git

    - name: Download Go binary
      get_url:
        url: "https://go.dev/dl/go{{ go_version }}.linux-amd64.tar.gz"
        dest: "/tmp/go{{ go_version }}.linux-amd64.tar.gz"

    - name: Extract Go binary
      unarchive:
        src: "/tmp/go{{ go_version }}.linux-amd64.tar.gz"
        dest: "/usr/local"
        remote_src: yes

    - name: Set up Go environment variables
      lineinfile:
        path: /home/go/.bash_profile
        line: "{{ item }}"
        create: yes
      with_items:
        - 'export GOROOT=/usr/local/go'
        - 'export PATH=$PATH:/usr/local/go/bin'

    - name: Install protoc-gen-go
      command: go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
      environment:
        PATH: "$PATH:/usr/local/go/bin"
      tags:
        - go-tools

    - name: Install protoc-gen-go-grpc
      command: go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
      environment:
        PATH: "$PATH:/usr/local/go/bin"
      tags:
        - go-tools

    - name: Build the application with make
      command: make node
      args:
        chdir: "{{ app_dir }}"
      environment:
        PATH: "$PATH:/usr/local/go/bin:/usr/bin:{{ ansible_env.HOME }}/go/bin"
      tags:
        - build
